<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>03 Caching `SpaDES` simulations • SpaDES.core</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="03 Caching `SpaDES` simulations">
<meta property="og:description" content="SpaDES.core">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-58633549-6"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-58633549-6');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpaDES.core</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/i-introduction.html">01 Introduction to `SpaDES`</a>
    </li>
    <li>
      <a href="../articles/ii-modules.html">02 Building `SpaDES` modules</a>
    </li>
    <li>
      <a href="../articles/iii-cache.html">03 Caching `SpaDES` simulations</a>
    </li>
    <li>
      <a href="../articles/iv-advanced.html">04 Advanced `SpaDES` use</a>
    </li>
    <li>
      <a href="../articles/v-automated-testing.html">05 Automated module testing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/PredictiveEcology/SpaDES.core/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>03 Caching <code>SpaDES</code> simulations</h1>
                        <h4 data-toc-skip class="author">Eliot J. B.
McIntire</h4>
            
            <h4 data-toc-skip class="date">July 05 2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/PredictiveEcology/SpaDES.core/blob/HEAD/vignettes/iii-cache.Rmd" class="external-link"><code>vignettes/iii-cache.Rmd</code></a></small>
      <div class="hidden name"><code>iii-cache.Rmd</code></div>

    </div>

    
    
<p>As part of a reproducible work flow, caching of various function
calls are a critical component. Down the road, it is likely that an
entire work flow from raw data to publication, decision support, report
writing, presentation building etc., could be built and be reproducible
anywhere, on demand. The <code><a href="https://reproducible.predictiveecology.org/reference/Cache.html" class="external-link">reproducible::Cache</a></code> function is
built to work with any R function. However, it becomes very powerful in
a <code>SpaDES</code> context because we can build large, powerful
applications that are transparent and tied to the raw data that may be
<em>many</em> conceptual steps upstream in the workflow. To do this, we
have built several customizations within the <code>SpaDES</code>
package. Important to this is dealing correctly with the
<code>simList</code>, which is an object that has slot that is an
environment. But more important are the various tools that can be used
at higher levels, <em>i.e.</em>, not just for “standard” functions.</p>
<div class="section level2">
<h2 id="caching-as-part-of-spades">Caching as part of <code>SpaDES</code><a class="anchor" aria-label="anchor" href="#caching-as-part-of-spades"></a>
</h2>
<p>Some of the details of the <code>simList</code>-specific features of
this <code>Cache</code> function include:</p>
<ul>
<li><p>The function converts all elements that have an environment as
part of their attributes into a format that has no unique environment
attribute, using <code>format</code> if a function, and
<code>as.list</code> in the case of the <code>simList</code>
environment.</p></li>
<li><p>When used within <code>SpaDES</code> modules, <code>Cache</code>
(capital C) does not require that the argument <code>cachePath</code> be
specified. If called from inside a SpaDES module, <code>Cache</code>
will use the <code>cachePath</code> argument from a call to
<code>cachePath(sim)</code>, taking the <code>sim</code> from the call
stack. Similarly, if no <code>cachePath</code> argument is specified,
then it will use <code>getOption("spades.cachePath")</code>, which will,
by default, be a temporary location with no persistence between R
sessions! To persist between sessions, use
<code>SpaDES::setPaths()</code> every session.</p></li>
</ul>
<p>In a <code>SpaDES</code> context, there are several levels of caching
that can be used as part of a reproducible workflow. Each level can be
used to a modeller’s advantage; and, all can be – and are often – used
concurrently.</p>
<div class="section level3">
<h3 id="at-the-spades-level">At the <code>spades</code> level<a class="anchor" aria-label="anchor" href="#at-the-spades-level"></a>
</h3>
<p>And entire call to <code>spades</code> can be cached. This will have
the effect of eliminating any stochasticity in the model as the output
will simply be the cached version of the <code>simList</code>. This is
likely most useful in situations where reproducibility is more important
than “new” stochasticity (<em>e.g.</em>, building decision support
systems, apps, final version of a manuscript).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://reproducible.predictiveecology.org" class="external-link">reproducible</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://spades-core.predictiveecology.org/">SpaDES.core</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">mySim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simInit.html">simInit</a></span><span class="op">(</span></span>
<span>  times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fl">0.0</span>, end <span class="op">=</span> <span class="fl">3.0</span><span class="op">)</span>,</span>
<span>  params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .globals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>stackName <span class="op">=</span> <span class="st">"landscape"</span>, burnStats <span class="op">=</span> <span class="st">"testStats"</span><span class="op">)</span>,</span>
<span>    randomLandscapes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.plotInitialTime <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    fireSpread <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.plotInitialTime <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  modules <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"randomLandscapes"</span>, <span class="st">"fireSpread"</span><span class="op">)</span>,</span>
<span>  paths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>modulePath <span class="op">=</span> <span class="fu"><a href="../reference/getSampleFiles.html">getSampleModules</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This functionality can be achieved within a <code>spades</code>
call.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># compare caching ... run once to create cache</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">outSim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spades.html">spades</a></span><span class="op">(</span><span class="fu"><a href="https://reproducible.predictiveecology.org/reference/Copy.html" class="external-link">Copy</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span>, cache <span class="op">=</span> <span class="cn">TRUE</span>, notOlderThan <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: RColorBrewer</span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:51       Using setDTthreads(1). To change: 'options(spades.DTthreads = X)'.</span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:51 chckpn <span style="color: #00BB00;"> total elpsd: 0.0037 secs | 0 checkpoint init 0</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:51 save   <span style="color: #00BB00;"> total elpsd: 0.0065 secs | 0 save init 0</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:51 prgrss <span style="color: #00BB00;"> total elpsd: 0.0089 secs | 0 progress init 0</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:51 load   <span style="color: #00BB00;"> total elpsd: 0.011 secs | 0 load init 0</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:51 rndmLn <span style="color: #00BB00;"> total elpsd: 0.013 secs | 0 randomLandscapes init</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:51 rndmLn The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,which was just loaded, will retire in October 2023.Please refer to R-spatial evolution reports for details, especiallyhttps://r-spatial.org/r/2023/05/15/evolution4.html.It may be desirable to make the sf package available;package maintainers should consider adding sf to Suggests:.The sp package is now running under evolution status 2     (status 2 uses the sf package in place of rgdal)</span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:52 rndmLn <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:52 rndmLn <span style="color: #BBBB00;">1:            landscape</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:52 frSprd <span style="color: #00BB00;"> total elpsd: 1.7 secs | 0 fireSpread init 1</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:52 frSprd <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:52 frSprd <span style="color: #BBBB00;">1:            testStats</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:52 frSprd <span style="color: #00BB00;"> total elpsd: 1.8 secs | 1 fireSpread burn 5</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:53 frSprd <span style="color: #00BB00;"> total elpsd: 1.9 secs | 1 fireSpread stats 5</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:53 frSprd <span style="color: #00BB00;"> total elpsd: 1.9 secs | 2 fireSpread burn 5</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:53 frSprd <span style="color: #00BB00;"> total elpsd: 2 secs | 2 fireSpread stats 5</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:53 frSprd <span style="color: #00BB00;"> total elpsd: 2 secs | 3 fireSpread burn 5</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:53 frSprd <span style="color: #00BB00;"> total elpsd: 2 secs | 3 fireSpread stats 5</span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BB00BB;">simList saved in</span></span></span>
<span><span class="co"><span style="color: #BB00BB;">##  </span><span style="color: #0000BB;">SpaDES.core:::.pkgEnv$.sim</span><span style="color: #BB00BB;"> </span></span></span>
<span><span class="co"><span style="color: #BB00BB;">## It will be deleted at next spades() call.</span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #0000BB;">Saving large object (cacheId: 3c15f60e1947c2e7) to Cache: 83 Mb</span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #0000BB;"> Done!</span></span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   5.037   0.196   5.237</span></span></code></pre>
<p>Note that if there were any visualizations (here we turned them off
with <code>.plotInitialTime = NA</code> above) they will happen the
first time through, but not the cached times.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># faster 2nd time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">outSimCached</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spades.html">spades</a></span><span class="op">(</span><span class="fu"><a href="https://reproducible.predictiveecology.org/reference/Copy.html" class="external-link">Copy</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #0000BB;">  ...(Object to retrieve (3c15f60e1947c2e7.rds))</span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #0000BB;">     loaded cached result from previous spades call</span></span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.566   0.004   0.572</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">outSim</span>, <span class="va">outSimCached</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">##  [1] "Names: 3 string mismatches"                                       </span></span>
<span><span class="co">##  [2] "Length mismatch: comparison on first 4 components"                </span></span>
<span><span class="co">##  [3] "Component 2: Modes: numeric, NULL"                                </span></span>
<span><span class="co">##  [4] "Component 2: Lengths: 4, 0"                                       </span></span>
<span><span class="co">##  [5] "Component 2: target is numeric, current is NULL"                  </span></span>
<span><span class="co">##  [6] "Component 3: target is NULL, current is PackedSpatRaster"         </span></span>
<span><span class="co">##  [7] "Component 4: Modes: S4, numeric"                                  </span></span>
<span><span class="co">##  [8] "Component 4: Lengths: 1, 3"                                       </span></span>
<span><span class="co">##  [9] "Component 4: Attributes: &lt; Modes: list, NULL &gt;"                   </span></span>
<span><span class="co">## [10] "Component 4: Attributes: &lt; Lengths: 4, 0 &gt;"                       </span></span>
<span><span class="co">## [11] "Component 4: Attributes: &lt; names for target but not for current &gt;"</span></span>
<span><span class="co">## [12] "Component 4: Attributes: &lt; current is not list-like &gt;"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="module-level-caching">Module-level caching<a class="anchor" aria-label="anchor" href="#module-level-caching"></a>
</h3>
<p>If the parameter <code>.useCache</code> in the module’s metadata is
set to <code>TRUE</code>, then <em>every</em> event in the module will
be cached. That means that every time that module is called from within
a <code><a href="../reference/spades.html">spades()</a></code> call, <code>Cache</code> will be called. Only
the objects inside the <code>simList</code> that correspond to the
<code>inputObjects</code> or the <code>outputObjects</code> from the
module metadata will be assessed for caching. For general use,
module-level caching would be mostly useful for modules that have no
stochasticity, such as data-preparation modules, GIS modules etc.</p>
<p>In this example, we will use the cache on the
<code>randomLandscapes</code> module. This means that each subsequent
call to spades will result in identical outputs from the
<code>randomLandscapes</code> module (only!). This would be useful when
only one random landscape is needed simply for trying something out, or
putting into production code (<em>e.g.</em>, publication, decision
support, etc.).</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Module-level</span></span>
<span><span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span><span class="op">$</span><span class="va">randomLandscapes</span><span class="op">$</span><span class="va">.useCache</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">randomSim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spades.html">spades</a></span><span class="op">(</span><span class="fu"><a href="https://reproducible.predictiveecology.org/reference/Copy.html" class="external-link">Copy</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span>, .plotInitialTime <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      notOlderThan <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, debug <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Jul05 15:13:57       Using setDTthreads(1). To change: 'options(spades.DTthreads = X)'.</span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:57 chckpn <span style="color: #00BB00;">eventTime moduleName eventType eventPriority</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:57 chckpn <span style="color: #00BB00;">0         checkpoint init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:57 save   <span style="color: #00BB00;">0         save       init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:57 prgrss <span style="color: #00BB00;">0         progress   init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:57 load   <span style="color: #00BB00;">0         load       init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:57 rndmLn <span style="color: #00BB00;">0         randomLandscapes init      1            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:13:59 rndmLn <span style="color: #0000BB;">Saving large object (cacheId: aaac067c5d4f51ca) to Cache: 82.9 Mb</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 rndmLn <span style="color: #0000BB;"> Done!</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 rndmLn <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 rndmLn <span style="color: #BBBB00;">1:            landscape</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 frSprd <span style="color: #00BB00;">0         fireSpread       init      1            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 frSprd <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 frSprd <span style="color: #BBBB00;">1:            testStats</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 frSprd <span style="color: #00BB00;">1         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 frSprd <span style="color: #00BB00;">1         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 frSprd <span style="color: #00BB00;">2         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 frSprd <span style="color: #00BB00;">2         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 frSprd <span style="color: #00BB00;">3         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:00 frSprd <span style="color: #00BB00;">3         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BB00BB;">simList saved in</span></span></span>
<span><span class="co"><span style="color: #BB00BB;">##  </span><span style="color: #0000BB;">SpaDES.core:::.pkgEnv$.sim</span><span style="color: #BB00BB;"> </span></span></span>
<span><span class="co"><span style="color: #BB00BB;">## It will be deleted at next spades() call.</span></span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   3.133   0.072   3.206</span></span></code></pre>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># faster the second time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">randomSimCached</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spades.html">spades</a></span><span class="op">(</span><span class="fu"><a href="https://reproducible.predictiveecology.org/reference/Copy.html" class="external-link">Copy</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span>, .plotInitialTime <span class="op">=</span> <span class="cn">NA</span>, debug <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Jul05 15:14:01       Using setDTthreads(1). To change: 'options(spades.DTthreads = X)'.</span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:01 chckpn <span style="color: #00BB00;">eventTime moduleName eventType eventPriority</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:01 chckpn <span style="color: #00BB00;">0         checkpoint init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:01 save   <span style="color: #00BB00;">0         save       init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:01 prgrss <span style="color: #00BB00;">0         progress   init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:01 load   <span style="color: #00BB00;">0         load       init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:01 rndmLn <span style="color: #00BB00;">0         randomLandscapes init      1            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:01 rndmLn <span style="color: #0000BB;">  ...(Object to retrieve (aaac067c5d4f51ca.rds))</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 rndmLn <span style="color: #0000BB;">     loaded cached copy of randomLandscapes module adding to memoised copy</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 rndmLn <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 rndmLn <span style="color: #BBBB00;">1:            landscape</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 frSprd <span style="color: #00BB00;">0         fireSpread       init      1            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 frSprd <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 frSprd <span style="color: #BBBB00;">1:            testStats</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 frSprd <span style="color: #00BB00;">1         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 frSprd <span style="color: #00BB00;">1         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 frSprd <span style="color: #00BB00;">2         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 frSprd <span style="color: #00BB00;">2         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 frSprd <span style="color: #00BB00;">3         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 frSprd <span style="color: #00BB00;">3         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BB00BB;">simList saved in</span></span></span>
<span><span class="co"><span style="color: #BB00BB;">##  </span><span style="color: #0000BB;">SpaDES.core:::.pkgEnv$.sim</span><span style="color: #BB00BB;"> </span></span></span>
<span><span class="co"><span style="color: #BB00BB;">## It will be deleted at next spades() call.</span></span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   1.076   0.000   1.078</span></span></code></pre>
<p>Test that only layers produced in <code>randomLandscapes</code> are
identical, not <code>fireSpread</code>.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">layers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"DEM"</span>, <span class="st">"forestAge"</span>, <span class="st">"habitatQuality"</span>, <span class="st">"percentPine"</span>, <span class="st">"Fires"</span><span class="op">)</span></span>
<span><span class="va">same</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">layers</span>, <span class="kw">function</span><span class="op">(</span><span class="va">l</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">randomSim</span><span class="op">$</span><span class="va">landscape</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span>, <span class="va">randomSimCached</span><span class="op">$</span><span class="va">landscape</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">same</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">layers</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">same</span><span class="op">)</span> <span class="co"># Fires is not same because all non-init events in fireSpread are not cached</span></span></code></pre></div>
<pre><code><span><span class="co">## $DEM</span></span>
<span><span class="co">## [1] FALSE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $forestAge</span></span>
<span><span class="co">## [1] FALSE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $habitatQuality</span></span>
<span><span class="co">## [1] FALSE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $percentPine</span></span>
<span><span class="co">## [1] FALSE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $Fires</span></span>
<span><span class="co">## [1] FALSE</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="event-level-caching">Event-level caching<a class="anchor" aria-label="anchor" href="#event-level-caching"></a>
</h3>
<p>If the parameter <code>.useCache</code> in the module’s metadata is
set to a <em>character or character vector</em>, then that or those
event(s), identified by their name, will be cached. That means that
every time the event is called from within a <code>spades</code> call,
<code>Cache</code> will be called. Only the objects inside the
<code>simList</code> that correspond to the <code>inputObjects</code> or
the <code>outputObjects</code> as defined in the module metadata will be
assessed for caching inputs or outputs, respectively. The fact that all
and only the named <code>inputObjects</code> and
<code>outputObjects</code> are cached and returned may be inefficient
(<em>i.e.</em>, it may cache more objects than are necessary) for
individual events.</p>
<p>Similar to module-level caching, event-level caching would be mostly
useful for events that have no stochasticity, such as data-preparation
events, GIS events etc. Here, we don’t change the module-level caching
for <code>randomLandscapes</code>, but we add to it a cache for only the
“init” event for <code>fireSpread</code>.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span><span class="op">$</span><span class="va">fireSpread</span><span class="op">$</span><span class="va">.useCache</span> <span class="op">&lt;-</span> <span class="st">"init"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">randomSim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spades.html">spades</a></span><span class="op">(</span><span class="fu"><a href="https://reproducible.predictiveecology.org/reference/Copy.html" class="external-link">Copy</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span>, .plotInitialTime <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      notOlderThan <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, debug <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Jul05 15:14:02       Using setDTthreads(1). To change: 'options(spades.DTthreads = X)'.</span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 chckpn <span style="color: #00BB00;">eventTime moduleName eventType eventPriority</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 chckpn <span style="color: #00BB00;">0         checkpoint init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 save   <span style="color: #00BB00;">0         save       init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 prgrss <span style="color: #00BB00;">0         progress   init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 load   <span style="color: #00BB00;">0         load       init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:02 rndmLn <span style="color: #00BB00;">0         randomLandscapes init      1            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:04 rndmLn <span style="color: #0000BB;">Saving large object (cacheId: aaac067c5d4f51ca) to Cache: 82.9 Mb</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:05 rndmLn <span style="color: #0000BB;"> Done!</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:05 rndmLn <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:05 rndmLn <span style="color: #BBBB00;">1:            landscape</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:05 frSprd <span style="color: #00BB00;">0         fireSpread       init      1            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:07 frSprd <span style="color: #0000BB;">Saving large object (cacheId: 5f571a97d9f99003) to Cache: 83 Mb</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:07 frSprd <span style="color: #0000BB;"> Done!</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:07 frSprd <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:07 frSprd <span style="color: #BBBB00;">1:            testStats</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:07 frSprd <span style="color: #00BB00;">1         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 frSprd <span style="color: #00BB00;">1         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 frSprd <span style="color: #00BB00;">2         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 frSprd <span style="color: #00BB00;">2         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 frSprd <span style="color: #00BB00;">3         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 frSprd <span style="color: #00BB00;">3         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BB00BB;">simList saved in</span></span></span>
<span><span class="co"><span style="color: #BB00BB;">##  </span><span style="color: #0000BB;">SpaDES.core:::.pkgEnv$.sim</span><span style="color: #BB00BB;"> </span></span></span>
<span><span class="co"><span style="color: #BB00BB;">## It will be deleted at next spades() call.</span></span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   5.380   0.020   5.405</span></span></code></pre>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># faster the second time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">randomSimCached</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spades.html">spades</a></span><span class="op">(</span><span class="fu"><a href="https://reproducible.predictiveecology.org/reference/Copy.html" class="external-link">Copy</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span>, .plotInitialTime <span class="op">=</span> <span class="cn">NA</span>, debug <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Jul05 15:14:08       Using setDTthreads(1). To change: 'options(spades.DTthreads = X)'.</span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 chckpn <span style="color: #00BB00;">eventTime moduleName eventType eventPriority</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 chckpn <span style="color: #00BB00;">0         checkpoint init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 save   <span style="color: #00BB00;">0         save       init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 prgrss <span style="color: #00BB00;">0         progress   init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 load   <span style="color: #00BB00;">0         load       init      0            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 rndmLn <span style="color: #00BB00;">0         randomLandscapes init      1            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 rndmLn <span style="color: #0000BB;">  ...(Object to retrieve (aaac067c5d4f51ca.rds))</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 rndmLn <span style="color: #0000BB;">     loaded cached copy of randomLandscapes module adding to memoised copy</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 rndmLn <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 rndmLn <span style="color: #BBBB00;">1:            landscape</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:08 frSprd <span style="color: #00BB00;">0         fireSpread       init      1            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #0000BB;">  ...(Object to retrieve (5f571a97d9f99003.rds))</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #0000BB;">     loaded cached copy of init event in fireSpread module.   </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #BBBB00;">New objects created:</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #BBBB00;">1:            testStats</span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #00BB00;">1         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #00BB00;">1         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #00BB00;">2         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #00BB00;">2         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #00BB00;">3         fireSpread       burn      5            </span></span></span></code></pre>
<pre><code><span><span class="co">## Jul05 15:14:09 frSprd <span style="color: #00BB00;">3         fireSpread       stats     5            </span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BB00BB;">simList saved in</span></span></span>
<span><span class="co"><span style="color: #BB00BB;">##  </span><span style="color: #0000BB;">SpaDES.core:::.pkgEnv$.sim</span><span style="color: #BB00BB;"> </span></span></span>
<span><span class="co"><span style="color: #BB00BB;">## It will be deleted at next spades() call.</span></span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   1.245   0.004   1.253</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="function-level-caching">Function-level caching<a class="anchor" aria-label="anchor" href="#function-level-caching"></a>
</h3>
<p>Any function can be cached using:
<code>Cache(FUN = functionName, ...)</code>.</p>
<p>This will be a slight change to a function call, such as:
<code>projectRaster(raster, crs = crs(newRaster))</code> to
<code>Cache(projectRaster, raster, crs = crs(newRaster))</code>.</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ras</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1e3</span>, <span class="fl">0</span>, <span class="fl">1e3</span><span class="op">)</span>, res <span class="op">=</span> <span class="fl">1</span>, vals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/robustDigest.html">Cache</a></span><span class="op">(</span><span class="fu">SpaDES.tools</span><span class="fu">::</span><span class="fu"><a href="https://spades-tools.predictiveecology.org/reference/neutralLandscapeMap.html" class="external-link">neutralLandscapeMap</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span>,</span>
<span>               cachePath <span class="op">=</span> <span class="fu"><a href="../reference/simList-accessors-paths.html">cachePath</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span>,</span>
<span>               userTags <span class="op">=</span> <span class="st">"neutralLandscapeMap"</span>,</span>
<span>               notOlderThan <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: In (SpaDES.tools::neutralLandscapeMap(ras))(): nlm_mpd changes the</span></span>
<span><span class="co">## dimensions of the RasterLayer if even ncols/nrows are choosen.</span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.802   0.021   0.826</span></span></code></pre>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># faster the second time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">mapCached</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/robustDigest.html">Cache</a></span><span class="op">(</span><span class="fu">SpaDES.tools</span><span class="fu">::</span><span class="fu"><a href="https://spades-tools.predictiveecology.org/reference/neutralLandscapeMap.html" class="external-link">neutralLandscapeMap</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span>,</span>
<span>                     cachePath <span class="op">=</span> <span class="fu"><a href="../reference/simList-accessors-paths.html">cachePath</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span>,</span>
<span>                     userTags <span class="op">=</span> <span class="st">"neutralLandscapeMap"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #0000BB;">  ...(Object to retrieve (94d035af43fc613d.rds))</span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #0000BB;">     loaded cached result from previous SpaDES.tools::neutralLandscapeMap call</span></span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.114   0.000   0.115</span></span></code></pre>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">map</span><span class="op">[</span><span class="op">]</span>, <span class="va">mapCached</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="co"># note --&gt; can't use all.equal on SpatRaster -- they are pointers </span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="working-with-the-cache-manually">Working with the Cache manually<a class="anchor" aria-label="anchor" href="#working-with-the-cache-manually"></a>
</h3>
<p>Since the cache is simply a <code>DBI</code> database table, all
<code>DBI</code> functions will work as is. In addition, there are
several helpers in the <code>reproducible</code> package, including
<code>showCache</code>, <code>keepCache</code> and
<code>clearCache</code>, and the more advanced <code>createCache</code>,
<code>loadFromCache</code>, <code>rmFromCache</code>, and
<code>saveToCache</code> that may be useful. Also, one can access cached
items manually (rather than simply rerunning the same <code>Cache</code>
function again).</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cacheDB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://reproducible.predictiveecology.org/reference/viewCache.html" class="external-link">showCache</a></span><span class="op">(</span><span class="va">mySim</span>, userTags <span class="op">=</span> <span class="st">"neutralLandscapeMap"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #0000BB;">Cache size: </span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #0000BB;">  Total (including Rasters): 1.9 Mb</span></span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #0000BB;">  Selected objects (not including Rasters): 1.9 Mb</span></span></span></code></pre>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## get the RasterLayer that was produced with neutralLandscapeMap()</span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://reproducible.predictiveecology.org/reference/CacheHelpers.html" class="external-link">loadFromCache</a></span><span class="op">(</span>cacheId <span class="op">=</span> <span class="va">cacheDB</span><span class="op">$</span><span class="va">cacheId</span>, cachePath <span class="op">=</span> <span class="fu"><a href="../reference/simList-accessors-paths.html">cachePath</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #0000BB;">     loaded cached result from previous  call</span></span></span></code></pre>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://quickplot.predictiveecology.org/reference/clearPlot.html" class="external-link">clearPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://quickplot.predictiveecology.org/reference/Plot.html" class="external-link">Plot</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span></span></code></pre></div>
<p><img src="iii-cache_files/figure-html/manual-cache-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="reproducible-workflow">Reproducible Workflow<a class="anchor" aria-label="anchor" href="#reproducible-workflow"></a>
</h2>
<p>In general, we feel that a liberal use of <code>Cache</code> will
make a reusable and reproducible work flow. <code>shiny</code> apps can
be made, taking advantage of <code>Cache</code>. Indeed, much of the
difficulty in managing data sets and saving them for future use, can be
accommodated by caching.</p>
<div class="section level3">
<h3 id="nested-caching">Nested Caching<a class="anchor" aria-label="anchor" href="#nested-caching"></a>
</h3>
<ul>
<li>Imagine we have large model with many modules</li>
<li>To run this would have a nested structure with the following
functions:</li>
</ul>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">simInit</span>() <span class="sc">-</span><span class="ot">-&gt;</span> many .inputObjects calls</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="fu">spades</span>() call <span class="sc">-</span><span class="ot">-&gt;</span> many module calls <span class="sc">-</span><span class="ot">-&gt;</span> many event calls <span class="sc">-</span><span class="ot">-&gt;</span> many <span class="cf">function</span> calls</span></code></pre></div>
<p>Lets say we start to introduce caching to this structure. We start
from the “inner” most functions that we could imaging Caching would be
useful. Lets say there are some GIS operations, like
<code><a href="https://rdrr.io/pkg/raster/man/projectRaster.html" class="external-link">raster::projectRaster</a></code>, which operates on an input
shapefile. We can Cache the <code>projectRaster</code> call to make this
much faster, since it will always be the same result for a given input
raster.</p>
<p>If we look back at our structure above, we see that we still have
LOTS of places that are not Cached. That means that the
<code><a href="../reference/spades.html">spades()</a></code> call will still spawn many module calls, and many
event calls, just to get to the one <code>Cache(projectRaster)</code>
call which is cached. This function will likely be called many times.
This is good, but <strong><code>Cache</code> does take some
time</strong>. So, even if <code>Cache(projectRaster)</code> takes only
0.02 seconds, calling it hundreds of times means maybe 4 seconds. If we
are doing this for many functions, then this will be too slow for some
purposes.</p>
<p>We can start putting <code>Cache</code> all up the sequence of calls.
Unfortunately, the way we use Cache at each of these levels is a bit
different, so we need a slightly different approach for each.</p>
<div class="section level5">
<h5 id="cache-the-spades-call">Cache the <code>spades</code> call<a class="anchor" aria-label="anchor" href="#cache-the-spades-call"></a>
</h5>
<p><code>spades(cache = TRUE)</code></p>
<p>This will cache the <code>spades</code> call, causing
stochasticity/randomness to be frozen.</p>
</div>
<div class="section level5">
<h5 id="cache-a-whole-module">Cache a whole module<a class="anchor" aria-label="anchor" href="#cache-a-whole-module"></a>
</h5>
<p>Pass <code>.useCache = TRUE</code> as a parameter to the module,
during the <code>simInit</code></p>
<p>Some modules are inherently non-random, such as GIS modules, or
parameter fitting statistical modules. We expect these to be identical
results each time, so we can safely cache the entire module.</p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parameters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  FireModule <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.useCache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mySim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simInit.html">simInit</a></span><span class="op">(</span><span class="va">...</span>, params <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span></span>
<span><span class="va">mySimOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spades.html">spades</a></span><span class="op">(</span><span class="va">mySim</span><span class="op">)</span></span></code></pre></div>
<p>The messaging should indicate the caching is happening on every event
in that module.</p>
<p><strong><em>Note: This option REQUIRES that the metadata in inputs
and outputs be exactly correct, i.e., all <code>inputObjects</code> and
<code>outputObjects</code> must be correctly identified and listed in
the <code>defineModule</code> metadata</em></strong></p>
<p><strong><em>If the module is cached, and there are errors when it is
run, it almost is guaranteed to be a problem with the
<code>inputObjects</code> and <code>outputObjects</code> incorrectly
specified.</em></strong></p>
</div>
<div class="section level5">
<h5 id="cache-individual-functions">Cache individual functions<a class="anchor" aria-label="anchor" href="#cache-individual-functions"></a>
</h5>
<p><code>Cache(&lt;functionName&gt;, &lt;other arguments&gt;)</code></p>
<p>This will allow fine scale control of individual function calls.</p>
</div>
</div>
<div class="section level3">
<h3 id="data-to-decisions">Data-to-decisions<a class="anchor" aria-label="anchor" href="#data-to-decisions"></a>
</h3>
<p>Once nested Caching is used all the way up to the
<code>experiment</code> (see <code>SpaDES.experiment</code> package)
level and even further up (e.g., if there is a <code>shiny</code>
module), then even very complex models can be put into a complete
workflow.</p>
<p>The current vision for <code>SpaDES</code> is that it will allow this
type of “data to decisions” complete workflow that allows for deep,
robust models, across disciplines, with easily accessible front ends,
that are quick and responsive to users, yet can handle data changes,
module changes, etc.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Alex M Chubaty, Eliot J B McIntire.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
