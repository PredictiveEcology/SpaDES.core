<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Use Pattern Oriented Modeling to fit unknown parameters — POM • SpaDES.core</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script>

<!-- sticky kit -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



<meta property="og:title" content="Use Pattern Oriented Modeling to fit unknown parameters — POM" />

<meta property="og:description" content="This is very much in alpha condition. It has been tested on simple problems,
as shown in the examples, with up to 2 parameters.
It appears that DEoptim is the superior package for the stochastic problems.
This should be used with caution as with all optimization routines. This function
can nevertheless take optim or genoud as optimizers, using
stats::optim or rgenoud::genoud, respectively.
However, these latter approaches do not seem appropriate for stochastic problems,
and have not been widely tested and are not supported within POM." />
<meta name="twitter:card" content="summary" />



<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-58633549-6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-58633549-6');
</script>

  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpaDES.core</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/i-introduction.html">01 Introduction to `SpaDES`</a>
    </li>
    <li>
      <a href="../articles/ii-modules.html">02 Building modules in `SpaDES`</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/PredictiveEcology/SpaDES.core">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Use Pattern Oriented Modeling to fit unknown parameters</h1>
    <small class="dont-index">Source: <a href='https://github.com/PredictiveEcology/SpaDES.core/blob/master/R/POM.R'><code>R/POM.R</code></a></small>
    <div class="hidden name"><code>POM.Rd</code></div>
    </div>

    <div class="ref-description">
    
    <p>This is very much in alpha condition. It has been tested on simple problems,
as shown in the examples, with up to 2 parameters.
It appears that <code>DEoptim</code> is the superior package for the stochastic problems.
This should be used with caution as with all optimization routines. This function
can nevertheless take <code>optim</code> or <code>genoud</code> as optimizers, using
<code><a href='http://www.rdocumentation.org/packages/stats/topics/optim'>stats::optim</a></code> or <code><a href='http://www.rdocumentation.org/packages/rgenoud/topics/genoud'>rgenoud::genoud</a></code>, respectively.
However, these latter approaches do not seem appropriate for stochastic problems,
and have not been widely tested and are not supported within <code>POM</code>.</p>
    
    </div>

    <pre class="usage"><span class='fu'>POM</span>(<span class='no'>sim</span>, <span class='no'>params</span>, <span class='kw'>objects</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='no'>objFn</span>, <span class='no'>cl</span>, <span class='kw'>optimizer</span> <span class='kw'>=</span> <span class='st'>"DEoptim"</span>,
  <span class='kw'>sterr</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='no'>...</span>, <span class='kw'>objFnCompare</span> <span class='kw'>=</span> <span class='st'>"MAD"</span>, <span class='kw'>optimControl</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>NaNRetries</span> <span class='kw'>=</span> <span class='fl'>NA</span>, <span class='kw'>logObjFnVals</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='no'>weights</span>, <span class='kw'>useLog</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>)

<span class='co'># S4 method for simList,character</span>
<span class='fu'>POM</span>(<span class='no'>sim</span>, <span class='no'>params</span>, <span class='kw'>objects</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='no'>objFn</span>, <span class='no'>cl</span>,
  <span class='kw'>optimizer</span> <span class='kw'>=</span> <span class='st'>"DEoptim"</span>, <span class='kw'>sterr</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='no'>...</span>, <span class='kw'>objFnCompare</span> <span class='kw'>=</span> <span class='st'>"MAD"</span>,
  <span class='kw'>optimControl</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>NaNRetries</span> <span class='kw'>=</span> <span class='fl'>NA</span>, <span class='kw'>logObjFnVals</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='no'>weights</span>, <span class='kw'>useLog</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>sim</th>
      <td><p>A <code>simList</code> simulation object, generally produced by <code>simInit</code>.</p></td>
    </tr>
    <tr>
      <th>params</th>
      <td><p>Character vector of parameter names that can be changed by the optimizer. These
must be accessible with <code><a href='params.html'>params(sim)</a></code> internally.</p></td>
    </tr>
    <tr>
      <th>objects</th>
      <td><p>A optional named list (must be specified if objFn is not).
The names of each list element must correspond to an object in the
<code>.GlobalEnv</code> and the list elements must be objects or
functions of objects that can be accessed in
the ls(sim) internally. These will be used to create the
objective function passed to the optimizer. See details and examples.</p></td>
    </tr>
    <tr>
      <th>objFn</th>
      <td><p>An optional objective function to be passed into <code>optimizer</code>.
If missing, then <code>POM</code> will use <code>objFnCompare</code> and
<code>objects</code> instead. If using <code>POM</code> with a SpaDES
simulation, this objFn must contain a spades call internally,
followed by a derivation of a value that can be minimized
but the <code>optimizer</code>. It must have, as first argument, the
values for the parameters. See example.</p></td>
    </tr>
    <tr>
      <th>cl</th>
      <td><p>A cluster object. Optional. This would generally be created using
parallel::makeCluster or equivalent. This is an alternative way, instead
of <code>beginCluster()</code>, to use parallelism for this function, allowing for
more control over cluster use.</p></td>
    </tr>
    <tr>
      <th>optimizer</th>
      <td><p>The function to use to optimize. Default is <code>"DEoptim"</code>.
Currently it can also be <code>"optim"</code> or <code>"rgenoud"</code>,
which use <code><a href='http://www.rdocumentation.org/packages/stats/topics/optim'>stats::optim</a></code> or <code><a href='http://www.rdocumentation.org/packages/rgenoud/topics/genoud'>rgenoud::genoud</a></code>, respectively.
The latter two do not seem optimal for stochastic problems and have
not been widely tested.</p></td>
    </tr>
    <tr>
      <th>sterr</th>
      <td><p>Logical. If using <code>optimizer = "optim"</code>, the hessian can be calculated.
If this is TRUE, then the standard errors can be estimated using
that hessian, assuming normality.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>All objects needed in objFn</p></td>
    </tr>
    <tr>
      <th>objFnCompare</th>
      <td><p>Character string. Either, "MAD" or "RMSE" indicating that inside the objective
function, data and prediction will be compared by Mean Absolute Deviation or
Root Mean Squared Error. Default is "MAD".</p></td>
    </tr>
    <tr>
      <th>optimControl</th>
      <td><p>List of control arguments passed into the control of each
optimization routine. Currently, only passed to
<code>DEoptim.control</code> when <code>optimizer</code> is <code>"DEoptim"</code></p></td>
    </tr>
    <tr>
      <th>NaNRetries</th>
      <td><p>Numeric. If greater than 1, then the function will retry
the objective function for a total of that number of times
if it results in an <code>NaN</code>. In general
this should not be used as the objective function should be
made so that it doesn't produce <code>NaN</code>. But, sometimes
it is difficult to diagnose stochastic results.</p></td>
    </tr>
    <tr>
      <th>logObjFnVals</th>
      <td><p>Logical or Character string indicating a filename to log the outputs.
Ignored if
<code>objFn</code> is supplied.
If TRUE (and there is no <code>objFn</code> supplied), then the
value of the individual patterns will be output the console
if being run interactively or to a tab delimited
text file named <code>ObjectiveFnValues.txt</code> (or that passed by
the user here) at each evaluation of the
POM created objective function. See details.</p></td>
    </tr>
    <tr>
      <th>weights</th>
      <td><p>Numeric. If provided, this vector will be multiplied by the standardized
deviations (possibly MAD or RMSE) as described in <code>objects</code>. This has
the effect of weighing
each standardized deviation (pattern--data pair) to a user
specified amount in the objective function.</p></td>
    </tr>
    <tr>
      <th>useLog</th>
      <td><p>Logical. Should the data patterns and output patterns be logged (<code>log</code>)
before calculating the <code>objFnCompare</code>. i.e.,
<code>mean(abs(log(output) - log(data)))</code>.
This should be length 1 or length <code>objects</code>.
It will be recycled if length &gt;1, less than <code>objects</code>.</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A list with at least 2 elements. The first (or first several) will
be the returned object from the optimizer. The second (or last if there are
more than 2), named <code>args</code> is the set of arguments that were passed
into the control of the optimizer.</p>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>There are two ways to use this function, via 1) <code>objFn</code> or 2) <code>objects</code>.</p>
<ol>
<li><p>The user can pass the entire objective function to the <code>objFn</code>
  argument that will be passed directly to the <code>optimizer</code>.
  For this, the user will likely need to pass named objects as part of the <code>...</code>.</p></li>
<li><p>The slightly simpler approach is to pass a list of 'actual data--simulated data'
  pairs as a named list in <code>objects</code> and specify how these objects should be
  compared via <code>objFnCompare</code> (whose default is Mean Absolute Deviation or "MAD").</p></li>
</ol>
    <p>Option 1 offers more control to the user, but may require more knowledge.
Option 1 should likely contain a call to <code><a href='simInit.html'>simInit(Copy(simList))</a></code> and
<code>spades</code> internally.
See examples that show simple examples of each type, option 1 and option 2.
In both cases, <code>params</code> is required to indicate which parameters can be
varied in order to achieve the fit.</p>
<p>Currently, option 1 only exists when optimizer is <code>"DEoptim"</code>, the default.</p>
<p>The upper and lower limits for parameter values are taken from the
metadata in the module. Thus, if the module metadata does not define the
upper and lower limits, or these are very wide, then the optimization
may have troubles. Currently, there is no way to override these upper
and lower limits; the module metadata should be changed if there needs
to be different parameter limits for optimization.</p>
<p><code>objects</code> is a named list of data--pattern pairs.
Each of these pairs will be assessed against one another using
the <code>objFnCompare</code>, after standardizing each independently. The
standardization, which only occurs if the abs(data value &lt; 1),
is: <code>mean(abs(derived value - data value))/mean(data value)</code>. If
the data value is between -1 and 1, then there is no standardization.
If there is more than one data--pattern
pair, then they will simply be added together in the objective
function. This gives equal weight to each pair. If the user wishes to
put different weight on each pattern, a <code>weights</code> vector can be
provided. This will be used to multiply the standardized values described above.
Alternatively, the user
may wish to weight them differently, in which case, their relative
scales can be adjusted.</p>
<p>There are many options that can be passed to <code><a href='http://www.rdocumentation.org/packages/DEoptim/topics/DEoptim'>DEoptim</a></code>,
(the details of which are in the help), using <code>optimControl</code>. The defaults
sent from <code>POM</code> to <code>DEoptim</code> are: steptol = 3 (meaning it will start
assessing convergence after 3 iterations (WHICH MAY NOT BE SUFFICIENT FOR YOUR PROBLEM),
<code>NP = 10 * length(params)</code>
(meaning the population size is 10 x the number of parameters) and itermax =
200 (meaning it won't go past 200 iterations). These and others may need to be adjusted to
obtain good values.
NOTE: <code>DEoptim</code> does not provide a direct estimate of confidence intervals.
Also, convergence may be unreliable, and may occur because <code>itermax</code> is reached.
Even when convergence is indicated, the estimates are not guaranteed to be global
optima. This is different than other optimizers that will normally indicate
if convergence was not achieved at termination of the optimization.</p>
<p>Using this function with a parallel cluster currently requires that you pass
<code>optimControl = list(parallelType = 1)</code>, and possibly package and variable names
 (and does not yet accept the <code>cl</code> argument). See examples.
This setting will use all available threads on your computer.
Future versions of this will allow passing of a custom cluster object via <code>cl</code> argument.
<code>POM</code> will automatically determine packages to load in the spawned cluster
(via <code><a href='packages.html'>packages</a></code>) and it will load all objects in the cluster that are
necessary, by sending <code><a href='http://www.rdocumentation.org/packages/raster/topics/names'>names(objects)</a></code> to <code>parVar</code> in <code>DEoptim.control</code>.</p>
<p>Setting <code>logObjFnVals</code> to <code>TRUE</code> may help diagnosing some problems.
Using the POM derived objective function, essentially all patterns are treated equally.
This may not give the correct behavior for the objective function.
Because <code>POM</code> weighs the patterns equally, it may be useful to use the
log files to examine the behaviour of the pattern--data pairs.
The first file, ObjectiveFnValues.txt, shows the result of each of the
(possibly logged), pattern--data deviations, standardized, and weighted.
The second file, <code class="file">ObjectiveFnValues_RawPatterns.txt</code>, shows the actual
value of the pattern (unstandardized, unweighted, unlogged).
If <code>weights</code> is passed, then these weighted values will be reflected
in the <code class="file">ObjectiveFnValues.txt</code> file.</p>
    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='spades.html'>spades</a></code>, <code><a href='http://www.rdocumentation.org/packages/parallel/topics/makeCluster'>makeCluster</a></code>,
<code><a href='simInit.html'>simInit</a></code></p></div>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'>if</span> (<span class='fu'>interactive</span>()) {
  <span class='fu'>set.seed</span>(<span class='fl'>89462</span>)
  <span class='fu'>library</span>(<span class='no'>parallel</span>)
  <span class='fu'>library</span>(<span class='no'>raster</span>)
  <span class='no'>mySim</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='simInit.html'>simInit</a></span>(
    <span class='kw'>times</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='kw'>start</span> <span class='kw'>=</span> <span class='fl'>0.0</span>, <span class='kw'>end</span> <span class='kw'>=</span> <span class='fl'>2.0</span>, <span class='kw'>timeunit</span> <span class='kw'>=</span> <span class='st'>"year"</span>),
    <span class='kw'>params</span> <span class='kw'>=</span> <span class='fu'>list</span>(
      <span class='kw'>.globals</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='kw'>stackName</span> <span class='kw'>=</span> <span class='st'>"landscape"</span>, <span class='kw'>burnStats</span> <span class='kw'>=</span> <span class='st'>"nPixelsBurned"</span>),
      <span class='kw'>fireSpread</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='kw'>nfires</span> <span class='kw'>=</span> <span class='fl'>5</span>),
      <span class='kw'>randomLandscapes</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='kw'>nx</span> <span class='kw'>=</span> <span class='fl'>300</span>, <span class='kw'>ny</span> <span class='kw'>=</span> <span class='fl'>300</span>)
    ),
    <span class='kw'>modules</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='st'>"randomLandscapes"</span>, <span class='st'>"fireSpread"</span>, <span class='st'>"caribouMovement"</span>),
    <span class='kw'>paths</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='kw'>modulePath</span> <span class='kw'>=</span> <span class='fu'>system.file</span>(<span class='st'>"sampleModules"</span>, <span class='kw'>package</span> <span class='kw'>=</span> <span class='st'>"SpaDES.core"</span>))
  )

  <span class='co'># Since this is a made up example, we don't have real data</span>
  <span class='co'>#  to run POM against. Instead, we will run the model once,</span>
  <span class='co'>#  take the values at the end of the simulation as if they</span>
  <span class='co'>#  are real data, then rerun the POM function next,</span>
  <span class='co'>#  comparing these "data" with the simulated values</span>
  <span class='co'>#  using Mean Absolute Deviation</span>
  <span class='no'>outData</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='spades.html'>spades</a></span>(<span class='kw pkg'>reproducible</span><span class='kw ns'>::</span><span class='fu'><a href='http://reproducible.predictiveecology.org/reference/Copy.html'>Copy</a></span>(<span class='no'>mySim</span>), <span class='kw'>.plotInitialTime</span> <span class='kw'>=</span> <span class='fl'>NA</span>)

  <span class='co'># Extract the "true" data, in this case, the "proportion of cells burned"</span>
  <span class='co'># Function defined that will use landscape$Fires map from simList,</span>
  <span class='co'>#  i.e., sim$landscape$Fires</span>
  <span class='co'>#  the return value being compared via MAD with propCellBurnedData</span>
  <span class='no'>propCellBurnedFn</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>landscape</span>) {
    <span class='fu'>sum</span>(<span class='fu'><a href='http://www.rdocumentation.org/packages/raster/topics/getValues'>getValues</a></span>(<span class='no'>landscape</span>$<span class='no'>Fires</span>) <span class='kw'>&gt;</span> <span class='fl'>0</span>) / <span class='fu'><a href='http://www.rdocumentation.org/packages/raster/topics/ncell'>ncell</a></span>(<span class='no'>landscape</span>$<span class='no'>Fires</span>)
  }
  <span class='co'># visualize the burned maps of true "data"</span>
  <span class='no'>propCellBurnedData</span> <span class='kw'>&lt;-</span> <span class='fu'>propCellBurnedFn</span>(<span class='no'>outData</span>$<span class='no'>landscape</span>)
  <span class='fu'>clearPlot</span>()
  <span class='kw'>if</span> (<span class='fu'>interactive</span>()) {
    <span class='no'>fires</span> <span class='kw'>&lt;-</span> <span class='no'>outData</span>$<span class='no'>landscape</span>$<span class='no'>Fires</span> <span class='co'># Plot doesn't do well with many nested layers</span>
    <span class='fu'>Plot</span>(<span class='no'>fires</span>)
  }

  <span class='co'># Example 1 - 1 parameter</span>
  <span class='co'># In words, this says, "find the best value of spreadprob such that</span>
  <span class='co'>#  the proportion of the area burned in the simulation</span>
  <span class='co'>#  is as close as possible to the proportion area burned in</span>
  <span class='co'>#  the "data", using \code{DEoptim()}.</span>

  <span class='co'># Can use cluster if computer is multi-threaded.</span>
  <span class='co'># This example can use parallelType = 1 in DEoptim. For this, you must manually</span>
  <span class='co'>#  pass all packages and variables as character strings.</span>
  <span class='co'># cl &lt;- makeCluster(detectCores() - 1) # not implemented yet in DEoptim</span>
  <span class='no'>out1</span> <span class='kw'>&lt;-</span> <span class='fu'>POM</span>(<span class='no'>mySim</span>, <span class='st'>"spreadprob"</span>,
              <span class='fu'>list</span>(<span class='kw'>propCellBurnedData</span> <span class='kw'>=</span> <span class='no'>propCellBurnedFn</span>), <span class='co'># data = pattern pair</span>
              <span class='co'>#optimControl = list(parallelType = 1),</span>
              <span class='kw'>logObjFnVals</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)

  <span class='co'>## Once cl arg is available from DEoptim, this will work:</span>
  <span class='co'># out1 &lt;- POM(mySim, "spreadprob", cl = cl,</span>
  <span class='co'>#            list(propCellBurnedData = propCellBurnedFn)) # data = pattern pair</span>

  <span class='co'># Example 2 - 2 parameters</span>
  <span class='co'># Function defined that will use caribou from sim$caribou, with</span>
  <span class='co'>#  the return value being compared via MAD with nPattern</span>
  <span class='co'>#  module, parameter N, is from 10 to 1000)</span>
  <span class='no'>caribouFn</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>caribou</span>) <span class='fu'>length</span>(<span class='no'>caribou</span>)

  <span class='co'># Extract "data" from simList object (normally, this would be actual data)</span>
  <span class='no'>nPattern</span> <span class='kw'>&lt;-</span> <span class='fu'>caribouFn</span>(<span class='no'>outData</span>$<span class='no'>caribou</span>)

  <span class='no'>aTime</span> <span class='kw'>&lt;-</span> <span class='fu'>Sys.time</span>()
  <span class='no'>parsToVary</span> <span class='kw'>&lt;-</span> <span class='fu'>c</span>(<span class='st'>"spreadprob"</span>, <span class='st'>"N"</span>)
  <span class='no'>out2</span> <span class='kw'>&lt;-</span> <span class='fu'>POM</span>(<span class='no'>mySim</span>, <span class='no'>parsToVary</span>,
              <span class='fu'>list</span>(<span class='kw'>propCellBurnedData</span> <span class='kw'>=</span> <span class='no'>propCellBurnedFn</span>,
                   <span class='kw'>nPattern</span> <span class='kw'>=</span> <span class='no'>caribouFn</span>), <span class='kw'>logObjFnVals</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)
                   <span class='co'>#optimControl = list(parallelType = 1))</span>
                   <span class='co'>#cl = cl) # not yet implemented, waiting for DEoptim</span>
  <span class='no'>bTime</span> <span class='kw'>&lt;-</span> <span class='fu'>Sys.time</span>()
  <span class='co'># check that population overlaps known values (0.225 and 100)</span>
  <span class='fu'>apply</span>(<span class='no'>out2</span>$<span class='no'>member</span>$<span class='no'>pop</span>, <span class='fl'>2</span>, <span class='no'>quantile</span>, <span class='fu'>c</span>(<span class='fl'>0.025</span>, <span class='fl'>0.975</span>))
  <span class='no'>hists</span> <span class='kw'>&lt;-</span> <span class='fu'>apply</span>(<span class='no'>out2</span>$<span class='no'>member</span>$<span class='no'>pop</span>, <span class='fl'>2</span>, <span class='no'>hist</span>, <span class='kw'>plot</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>)
  <span class='fu'>clearPlot</span>()
  <span class='kw'>for</span> (<span class='no'>i</span> <span class='kw'>in</span> <span class='fu'>seq_along</span>(<span class='no'>hists</span>)) <span class='fu'>Plot</span>(<span class='no'>hists</span><span class='kw'>[[</span><span class='no'>i</span>]], <span class='kw'>addTo</span> <span class='kw'>=</span> <span class='no'>parsToVary</span>[<span class='no'>i</span>],
                                   <span class='kw'>title</span> <span class='kw'>=</span> <span class='no'>parsToVary</span>[<span class='no'>i</span>], <span class='kw'>axes</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)

  <span class='fu'>print</span>(<span class='fu'>paste</span>(<span class='st'>"DEoptim"</span>, <span class='fu'>format</span>(<span class='no'>bTime</span> - <span class='no'>aTime</span>)))
  <span class='co'>#stopCluster(cl) # not yet implemented, waiting for DEoptim</span>

  <span class='co'># Example 3 - using objFn instead of objects</span>

  <span class='co'># list all the parameters in the simList, from these, we select to vary</span>
  <span class='fu'><a href='params.html'>params</a></span>(<span class='no'>mySim</span>)

  <span class='co'># Objective Function Example:</span>
  <span class='co'>#   objective function must have several elements</span>
  <span class='co'>#   - first argument must be parameter vector, passed to and used by DEoptim</span>
  <span class='co'>#   - likely needs to take sim object, likely needs a copy</span>
  <span class='co'>#      because of pass-by-reference semantics of sim objects</span>
  <span class='co'>#   - pass data that will be used internally for objective function</span>
  <span class='no'>objFnEx</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>pars</span>, <span class='co'># param values</span>
                      <span class='no'>sim</span>, <span class='co'># simList object</span>
                      <span class='no'>nPattern</span>, <span class='no'>propCellBurnedData</span>, <span class='no'>caribouFn</span>, <span class='no'>propCellBurnedFn</span>) {
    <span class='co'>### data</span>

    <span class='co'># make a copy of simList because it will possibly be altered by spades call</span>
    <span class='no'>sim1</span> <span class='kw'>&lt;-</span> <span class='kw pkg'>reproducible</span><span class='kw ns'>::</span><span class='fu'><a href='http://reproducible.predictiveecology.org/reference/Copy.html'>Copy</a></span>(<span class='no'>sim</span>)

    <span class='co'># take the parameters and assign them to simList</span>
    <span class='fu'><a href='params.html'>params</a></span>(<span class='no'>sim1</span>)$<span class='no'>fireSpread</span>$<span class='no'>spreadprob</span> <span class='kw'>&lt;-</span> <span class='no'>pars</span>[<span class='fl'>1</span>]
    <span class='fu'><a href='params.html'>params</a></span>(<span class='no'>sim1</span>)$<span class='no'>caribouMovement</span>$<span class='no'>N</span> <span class='kw'>&lt;-</span> <span class='no'>pars</span>[<span class='fl'>2</span>]

    <span class='co'># run spades, without plotting</span>
    <span class='no'>out</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='spades.html'>spades</a></span>(<span class='no'>sim1</span>, <span class='kw'>.plotInitialTime</span> <span class='kw'>=</span> <span class='fl'>NA</span>)

    <span class='co'># calculate outputs</span>
    <span class='no'>propCellBurnedOut</span> <span class='kw'>&lt;-</span> <span class='fu'>propCellBurnedFn</span>(<span class='no'>out</span>$<span class='no'>landscape</span>)
    <span class='no'>nPattern_Out</span> <span class='kw'>&lt;-</span> <span class='fu'>caribouFn</span>(<span class='no'>out</span>$<span class='no'>caribou</span>)

    <span class='no'>minimizeFn</span> <span class='kw'>&lt;-</span> <span class='fu'>abs</span>(<span class='no'>nPattern_Out</span> - <span class='no'>nPattern</span>) +
                  <span class='fu'>abs</span>(<span class='no'>propCellBurnedOut</span> - <span class='no'>propCellBurnedData</span>)

    <span class='co'># have more info reported to console, if desired</span>
    <span class='co'># cat(minimizeFn)</span>
    <span class='co'># cat(" ")</span>
    <span class='co'># cat(pars)</span>
    <span class='co'># cat("\n")</span>

    <span class='fu'>return</span>(<span class='no'>minimizeFn</span>)
  }

  <span class='co'># Run DEoptim with custom objFn, identifying 2 parameters to allow</span>
  <span class='co'>#  to vary, and pass all necessary objects required for the</span>
  <span class='co'>#  objFn</span>

  <span class='co'># choose 2 of them to vary. Need to identify them in params &amp; inside objFn</span>
  <span class='co'># Change optimization parameters to alter how convergence is achieved</span>
  <span class='no'>out5</span> <span class='kw'>&lt;-</span> <span class='fu'>POM</span>(<span class='no'>mySim</span>, <span class='kw'>params</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='st'>"spreadprob"</span>, <span class='st'>"N"</span>),
              <span class='kw'>objFn</span> <span class='kw'>=</span> <span class='no'>objFnEx</span>,
              <span class='kw'>nPattern</span> <span class='kw'>=</span> <span class='no'>nPattern</span>,
              <span class='kw'>propCellBurnedData</span> <span class='kw'>=</span> <span class='no'>propCellBurnedData</span>,
              <span class='kw'>caribouFn</span> <span class='kw'>=</span> <span class='no'>caribouFn</span>,
              <span class='kw'>propCellBurnedFn</span> <span class='kw'>=</span> <span class='no'>propCellBurnedFn</span>,
              <span class='co'>#cl = cl, # uncomment for cluster # not yet implemented, waiting for DEoptim</span>
              <span class='co'># see ?DEoptim.control for explanation of these options</span>
              <span class='kw'>optimControl</span> <span class='kw'>=</span> <span class='fu'>list</span>(
                <span class='kw'>NP</span> <span class='kw'>=</span> <span class='fl'>100</span>, <span class='co'># run 100 populations, allowing quantiles to be calculated</span>
                <span class='kw'>initialpop</span> <span class='kw'>=</span> <span class='fu'>matrix</span>(<span class='fu'>c</span>(<span class='fu'>runif</span>(<span class='fl'>100</span>, <span class='fl'>0.2</span>, <span class='fl'>0.24</span>), <span class='fu'>runif</span>(<span class='fl'>100</span>, <span class='fl'>80</span>, <span class='fl'>120</span>)), <span class='kw'>ncol</span> <span class='kw'>=</span> <span class='fl'>2</span>),
                <span class='kw'>parallelType</span> <span class='kw'>=</span> <span class='fl'>1</span>
              )
            )

  <span class='co'># Can also use an optimizer directly -- miss automatic parameter bounds,</span>
  <span class='co'>#  and automatic objective function using option 2</span>
  <span class='fu'>library</span>(<span class='no'>DEoptim</span>)
  <span class='no'>out7</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='http://www.rdocumentation.org/packages/DEoptim/topics/DEoptim'>DEoptim</a></span>(<span class='kw'>fn</span> <span class='kw'>=</span> <span class='no'>objFnEx</span>,
                 <span class='kw'>sim</span> <span class='kw'>=</span> <span class='no'>mySim</span>,
                 <span class='kw'>nPattern</span> <span class='kw'>=</span> <span class='no'>nPattern</span>,
                 <span class='kw'>propCellBurnedData</span> <span class='kw'>=</span> <span class='no'>propCellBurnedData</span>,
                 <span class='kw'>caribouFn</span> <span class='kw'>=</span> <span class='no'>caribouFn</span>,
                 <span class='kw'>propCellBurnedFn</span> <span class='kw'>=</span> <span class='no'>propCellBurnedFn</span>,
                 <span class='co'># cl = cl, # uncomment for cluster</span>
                 <span class='co'># see ?DEoptim.control for explanation of these options</span>
                 <span class='kw'>control</span> <span class='kw'>=</span> <span class='fu'><a href='http://www.rdocumentation.org/packages/DEoptim/topics/DEoptim.control'>DEoptim.control</a></span>(
                   <span class='kw'>steptol</span> <span class='kw'>=</span> <span class='fl'>3</span>,
                   <span class='kw'>parallelType</span> <span class='kw'>=</span> <span class='fl'>1</span>, <span class='co'># parallelType = 3,</span>
                   <span class='kw'>packages</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='st'>"raster"</span>, <span class='st'>"SpaDES.core"</span>, <span class='st'>"RColorBrewer"</span>),
                   <span class='kw'>parVar</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='st'>"objFnEx"</span>),
                   <span class='kw'>initialpop</span> <span class='kw'>=</span> <span class='fu'>matrix</span>(<span class='fu'>c</span>(<span class='fu'>runif</span>(<span class='fl'>40</span>, <span class='fl'>0.2</span>, <span class='fl'>0.24</span>),
                                         <span class='fu'>runif</span>(<span class='fl'>40</span>, <span class='fl'>80</span>, <span class='fl'>120</span>)), <span class='kw'>ncol</span> <span class='kw'>=</span> <span class='fl'>2</span>)),
                 <span class='kw'>lower</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='fl'>0.2</span>, <span class='fl'>80</span>), <span class='kw'>upper</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='fl'>0.24</span>, <span class='fl'>120</span>))
}</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#details">Details</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

    <h2>Author</h2>
    
Eliot McIntire

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by Alex M Chubaty, Eliot J B McIntire.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  

  </body>
</html>

